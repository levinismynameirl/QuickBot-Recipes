name: Validate Formulas

on:
  push:
    branches: [main]
    paths:
      - 'registry/**/*.rb'
      - 'abstract/**/*.rb'
  pull_request:
    branches: [main]
    paths:
      - 'registry/**/*.rb'
      - 'abstract/**/*.rb'

jobs:
  lint:
    name: Lint Ruby
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version-file: '.ruby-version'
          bundler-cache: true
      
      - name: Install RuboCop
        run: gem install rubocop rubocop-performance
      
      - name: Run RuboCop
        run: rubocop registry/ abstract/ --format progress

  validate:
    name: Validate Formulas
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version-file: '.ruby-version'
      
      - name: Validate formula syntax
        run: |
          for formula in registry/*/*.rb; do
            echo "Validating: $formula"
            ruby -c "$formula" || exit 1
          done
          echo "All formulas have valid syntax."
      
      - name: Check for duplicate plugin names
        run: |
          echo "Checking for duplicate plugin names..."
          find registry -name "*.rb" -type f | \
            xargs -I {} basename {} .rb | \
            sort | uniq -d | \
            { read dups && [ -z "$dups" ] || (echo "Duplicate plugins: $dups" && exit 1); }
          echo "No duplicates found."

  verify-urls:
    name: Verify Download URLs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get changed formulas
        id: changed
        run: |
          CHANGED=$(git diff --name-only origin/main... | grep "^registry/.*\.rb$" || true)
          echo "formulas=$CHANGED" >> $GITHUB_OUTPUT
      
      - name: Check URLs are accessible
        if: steps.changed.outputs.formulas != ''
        run: |
          for formula in ${{ steps.changed.outputs.formulas }}; do
            echo "Checking URLs in: $formula"
            URL=$(grep -oP 'url\s+"https?://[^"]+' "$formula" | sed 's/url "//' || true)
            if [ -n "$URL" ]; then
              echo "  Checking: $URL"
              curl --head --fail --silent "$URL" > /dev/null || \
                (echo "  ERROR: URL not accessible" && exit 1)
              echo "  âœ“ URL is accessible"
            fi
          done
